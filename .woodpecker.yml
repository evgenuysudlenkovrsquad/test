# .woodpecker.yml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€: push Ð² develop Ð¸Ð»Ð¸ sandbox,
# Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹, Ð·Ð°Ñ‚Ñ€Ð°Ð³Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ *.md
when:
  event: push
  branch: [develop, sandbox]
  path:
    exclude: ['**/*.md']

# ÐšÑÑˆ Kaniko â€” ÑƒÑÐºÐ¾Ñ€ÑÐµÑ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸
volumes:
  - name: kaniko-cache
    temp: {}

steps:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: init-vars
  image: alpine:3.19
  environment:
    KUBE_CONFIG:
      from_secret: kube_config
    APPS: '["indexer","relayer"]'
  commands:
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ STAGE Ð¸ namespace Ð¿Ð¾ Ð²ÐµÑ‚ÐºÐµ
    - |
      case "$CI_COMMIT_BRANCH" in
        develop)
          echo "STAGE=develop"            >> .env
          echo "APP_NAMESPACE=ton-teleport-dev"  >> .env
          ;;
        sandbox)
          echo "STAGE=sandbox"            >> .env
          echo "APP_NAMESPACE=ton-teleport-sand" >> .env
          ;;
        *) exit 78 ;;          # Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ° â†’ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐº
      esac
      echo "SHORT_SHA=${CI_COMMIT_SHA:0:7}" >> .env

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: build-images
  image: gcr.io/kaniko-project/executor:debug
  depends_on: [init-vars]
  volumes:
    - name: kaniko-cache
      path: /kaniko/cache
  commands:
    - apk add --no-cache bash curl jq kubectl
    - source .env
    - echo "$KUBE_CONFIG" > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - kubectl config use-context "$(kubectl config get-contexts -o name | head -n1)"

    # Ð”Ð¾ÑÑ‚Ð°Ñ‘Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Docker-Ñ€ÐµÐµÑÑ‚Ñ€Ð° Ð¸Ð· Kubernetes-ÑÐµÐºÑ€ÐµÑ‚Ð°
    - |
      reg=$(kubectl -n "$APP_NAMESPACE" get secret docker-registry-creds \
            -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d)
      REG_URL=$(echo "$reg" | jq -r '.auths | to_entries[0].key')
      USER=$(echo "$reg" | jq -r '.auths | to_entries[0].value.username')
      PASS=$(echo "$reg" | jq -r '.auths | to_entries[0].value.password')

      # Kaniko Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð· /kaniko/.docker/config.json
      mkdir -p /kaniko/.docker
      printf '{"auths": {"%s": {"username":"%s","password":"%s"}}}' \
             "$REG_URL" "$USER" "$PASS" > /kaniko/.docker/config.json

    # ÐšÐ°Ð½Ð¸ÐºÐ¾-ÑÐ±Ð¾Ñ€ÐºÐ°/Ð¿ÑƒÑˆ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
    - |
      for app in $(echo "$APPS" | jq -r '.[]'); do
        echo "ðŸ“¦  Build $app"
        /kaniko/executor \
          --context "$PWD" \
          --dockerfile "$app/Dockerfile" \
          --destination "$REG_URL/${app}-${STAGE}:latest" \
          --destination "$REG_URL/${app}-${STAGE}:$SHORT_SHA" \
          --cache=true --cache-dir=/kaniko/cache
      done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: deploy
  image: alpine/k8s:1.30.1           # kubectl + helm
  depends_on: [build-images]
  commands:
    - apk add --no-cache bash curl jq helm
    - source .env
    - echo "$KUBE_CONFIG" > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - kubectl config use-context "$(kubectl config get-contexts -o name | head -n1)"

    # URL Ñ€ÐµÐµÑÑ‚Ñ€Ð° ÑÐ½Ð¾Ð²Ð° Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· kubectl
    - |
      reg=$(kubectl -n "$APP_NAMESPACE" get secret docker-registry-creds \
            -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d)
      REG_URL=$(echo "$reg" | jq -r '.auths | to_entries[0].key')

      failed=0
      for app in $(echo "$APPS" | jq -r '.[]'); do
        echo "âŽˆ  Deploy $app"

        # ÑÐµÐºÑ€ÐµÑ‚Ð° Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ Ð±Ñ‹Ñ‚ÑŒ â€” Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ ÑƒÑÐ»Ð¾Ð²Ð½Ð¾
        SECRET_OPT=""
        kubectl -n "$APP_NAMESPACE" get secret "${app}-secrets" &>/dev/null \
          && SECRET_OPT="--set secretName=${app}-secrets"

        VAL_OPT=""
        [ -f "${app}/${app}-${STAGE}.yml" ] && VAL_OPT="-f ${app}/${app}-${STAGE}.yml"

        helm upgrade --install "$app" ./helm \
          --namespace "$APP_NAMESPACE" \
          --set image.repository="$REG_URL/${app}-${STAGE}" \
          --set image.tag="$SHORT_SHA" \
          --set app.name="$app" \
          --set configMapName=envs-config \
          $SECRET_OPT $VAL_OPT \
          --atomic --timeout 5m --history-max 2 || failed=1
      done
      [ $failed -eq 0 ] || exit 1
